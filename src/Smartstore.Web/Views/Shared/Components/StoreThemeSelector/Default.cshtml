@{
    var currentTheme = ViewBag.CurrentStoreTheme as StoreThemeModel;
    var themes = ViewBag.AvailableStoreThemes as List<StoreThemeModel>;

    if (themes.Count <= 1)
    {
        return;
    }

    var brownTheme = themes.FirstOrDefault(x => x.Name.ToLower().Contains("brown"));
    var yellowTheme = themes.FirstOrDefault(x => x.Name.ToLower().Contains("yellow"));
    var isYellow = currentTheme?.Name == yellowTheme?.Name;
}

<div class="theme-toggle" data-toggle="tooltip" data-placement="top" title="Switch to @(isYellow ? (brownTheme?.Title ?? "Brown") : (yellowTheme?.Title ?? "Yellow")) mode">
    <div class="toggle-slider @(isYellow ? "toggle-brown" : "toggle-yellow")">
        <div class="toggle-knob"></div>
    </div>
</div>

<style>
/* Smaller size toggle */
.theme-toggle {
    width: 48px;
    height: 24px;
    border-radius: 24px;
    cursor: pointer;
    position: relative;
}

/* Opposite background based on theme */
.toggle-slider {
    width: 100%;
    height: 100%;
    border-radius: 24px;
    position: relative;
    transition: background-color 0.3s ease;
}

/* If current theme is yellow, slider background should be brown (opposite) */
.toggle-brown {
    background-color: #7B4A1E; /* brown */
}

/* If current theme is brown, slider background should be yellow (opposite) */
.toggle-yellow {
    background-color: #FFD600; /* yellow */
}

/* White circular knob */
.toggle-knob {
    width: 18px;
    height: 18px;
    background-color: white;
    border-radius: 50%;
    position: absolute;
    top: 3px;
    left: 3px;
    transition: transform 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

/* Shift knob to right if yellow is active */
.toggle-brown .toggle-knob {
    transform: translateX(0);
}

.toggle-yellow .toggle-knob {
    transform: translateX(24px);
}
</style>

<script>
    $(function () {
        // Initialize theme selector functionality
        initializeThemeSelector();
    });

    function initializeThemeSelector() {
        // Use event delegation for all theme toggles
        $(document).on('click', '.theme-toggle', function (e) {
            e.preventDefault();
            e.stopPropagation();
            
            const $toggle = $(this);
            const $slider = $toggle.find('.toggle-slider');
            const isCurrentlyYellow = $slider.hasClass('toggle-yellow');
            const newTheme = isCurrentlyYellow ? '@brownTheme?.Name' : '@yellowTheme?.Name';
            const newMode = isCurrentlyYellow ? '@brownTheme?.Title' : '@yellowTheme?.Title';

            // Disable click during transition
            $toggle.css('pointer-events', 'none');

            // Update tooltip text
            $toggle.attr('data-original-title', 'Switch to ' + newMode + ' mode').tooltip('show');

            // Toggle slider background class
            $slider.toggleClass('toggle-yellow toggle-brown');

            // Submit theme change via AJAX
            $.ajax({
                url: '@Url.Action("ChangeTheme", "Common")',
                type: 'POST',
                data: { themeName: newTheme },
                success: function() {
                    // Store the new theme state in localStorage
                    localStorage.setItem('currentTheme', newTheme);
                    
                    // Reload page after successful theme change
                    window.location.reload();
                },
                error: function() {
                    // Revert toggle state on error
                    $slider.toggleClass('toggle-yellow toggle-brown');
                    // Re-enable click after error
                    $toggle.css('pointer-events', 'auto');
                }
            });
        });

        // Initialize tooltips for all theme toggles
        $('.theme-toggle').tooltip();

        // Sync theme state on page load
        const storedTheme = localStorage.getItem('currentTheme');
        if (storedTheme) {
            const isStoredYellow = storedTheme === '@yellowTheme?.Name';
            $('.theme-toggle .toggle-slider').removeClass('toggle-yellow toggle-brown')
                .addClass(isStoredYellow ? 'toggle-yellow' : 'toggle-brown');
        }
    }
</script>
