@using Smartstore.Core.Checkout.Cart
@using Smartstore.Web.Models.Catalog

@model ProductSummaryItemModel

@{
    var list = Model.Parent;
    var price = Model.Price;
    var isLinesMode = list.ViewMode == ProductSummaryViewMode.List;
    string artDetailUrl = ViewBag.ArtDetailUrl;

    bool isGuest = !User.Identity.IsAuthenticated;
    bool anonymousCheckoutAllowed = true; // Adjust this according to your logic

    string checkoutUrl = (anonymousCheckoutAllowed && isGuest)
        ? Url.RouteUrl("Login", new { checkoutAsGuest = true, returnUrl = Url.RouteUrl("Checkout") })
        : Url.RouteUrl("Checkout");

    string antiForgeryToken = "";

    // Render Anti-Forgery token value for AJAX calls (if token is generated in layout/form)
    var antiforgery = Context.RequestServices.GetService(typeof(Microsoft.AspNetCore.Antiforgery.IAntiforgery)) as Microsoft.AspNetCore.Antiforgery.IAntiforgery;
    if (antiforgery != null)
    {
        var tokens = antiforgery.GetAndStoreTokens(Context);
        antiForgeryToken = tokens.RequestToken;
    }

    void RenderBuyButton(bool blockStyle)
    {
        var cssClasses = blockStyle ? "btn-block d-none d-md-block" : "btn-lg art-btn col";
        if (!blockStyle && isLinesMode)
        {
            cssClasses += " d-md-none";
        }

        if (!Model.Price.CallForPrice)
        {
            var addToCartUrl = Url.Action("AddProductSimple", "ShoppingCart", new
            {
                productId = Model.Id,
                forceredirection = Model.Parent.ForceRedirectionAfterAddingToCart,
                area = ""
            });
            var title = Model.Price.AvailableForPreOrder
                ? T("ShoppingCart.PreOrder")
                : T("ShoppingCart.AddToCart");

            <a data-href="@addToCartUrl"
               href="#"
               class="btn btn-primary ajax-cart-link px-sm-2 @cssClasses add-to-cart-button"
               title="@title"
               data-toggle="@(!blockStyle ? "tooltip" : "")"
               data-placement="bottom"
               rel="nofollow"
               data-type="cart"
               data-action="add">
                <i class="fa fa-cart-arrow-down"></i>
                @if (blockStyle)
                {
                    <span>@title</span>
                }
                else if (isLinesMode)
                {
                    <span class="d-none d-sm-inline">@title</span>
                }
            </a>
        }
        else
        {
            <a href="@Url.Action("AskQuestion", "Product", new { id = Model.Id, area = "" })"
               class="btn @(blockStyle ? "btn-light" : "btn-gray") @cssClasses"
               data-toggle="@(!blockStyle ? "tooltip" : "")"
               data-placement="bottom"
               rel="nofollow"
               title="@T("Products.CallForPrice.GoToForm")">
                <i class="fa fa-question"></i>
                @if (blockStyle)
                {
                    <span>@T("Products.CallForPrice.GoToForm")</span>
                }
                else if (isLinesMode)
                {
                    <span class="d-none d-sm-inline">@T("Products.CallForPrice.GoToForm")</span>
                }
            </a>
        }
    }

    void RenderBuyNowButton(bool blockStyle)
    {
        var cssClasses = blockStyle
            ? "btn btn-primary btn-lg art-btn col btn-block d-none d-md-block"
            : "btn btn-primary btn-lg art-btn col";

        if (!blockStyle && isLinesMode)
        {
            cssClasses += " d-md-none";
        }

        var buyNowUrl = Url.Action("AddProductSimple", "ShoppingCart", new
        {
            productId = Model.Id,
            forceredirection = Model.Parent.ForceRedirectionAfterAddingToCart,
            area = ""
        });

        <text>
        <a href="javascript:void(0);"
           class="@cssClasses"
           rel="nofollow"
           title="buy now"
           data-toggle="tooltip"
           data-placement="bottom"
           onclick="(async (btn) => {
               try {
                   btn.disabled = true;
                   var originalHtml = btn.innerHTML;
                   btn.innerHTML = '&lt;i class=&quot;fa fa-spinner fa-spin&quot;&gt;&lt;/i&gt; @T("Common.Processing")';

                   // Clear the cart
                   const clearResponse = await fetch('@Url.Action("ClearCart", "ShoppingCart")', {
                       method: 'POST',
                       headers: {
                           'X-Requested-With': 'XMLHttpRequest',
                           'RequestVerificationToken': '@antiForgeryToken'
                       }
                   });
                   if (!clearResponse.ok) throw new Error('@T("ShoppingCart.ClearCartFailed")');

                   // Add product with form data
                   const form = document.querySelector('#pd-form');
                   const formData = form ? new FormData(form) : new FormData();
                   formData.set('productId', '@Model.Id');

                   const addResponse = await fetch('@buyNowUrl', {
                       method: 'POST',
                       body: formData,
                       headers: {
                           'X-Requested-With': 'XMLHttpRequest',
                           'RequestVerificationToken': '@antiForgeryToken'
                       }
                   });

                   if (!addResponse.ok) throw new Error('@T("ShoppingCart.AddToCartFailed")');

                   // Redirect to checkout page
                   window.location.href = '@checkoutUrl';
               } catch (error) {
                   console.error(error);
                   alert(error.message || 'An unexpected error occurred');
               } finally {
                   btn.innerHTML = btn.innerHTML.includes('fa-spinner') ? btn.innerHTML = originalHtml : btn.innerHTML;
                   btn.disabled = false;
               }
           })(this)">
            <i class="fa fa-bolt d-none d-sm-inline-block"></i>
            @if (blockStyle)
            {
                <span>@T("Products.BuyNow")</span>
            }
        </a>
        </text>
    }
}

<!-- Hidden form for productId and quantity -->
<form id="pd-form" method="post" style="display:none;">
    <input type="hidden" name="productId" value="@Model.Id" />
    <label for="quantity" class="sr-only">Quantity</label>
    <input type="number" id="quantity" name="quantity" value="1" min="1" />
    @Html.AntiForgeryToken()
</form>

@if (isLinesMode && !price.DisableBuyButton && list.BuyEnabled)
{
    <div class="mt-3">
        <div class="d-flex gap-2">
            @{ RenderBuyButton(true); }
            @{ RenderBuyNowButton(true); }
        </div>
    </div>
}

<div class="row no-gutters art-btn-group @(isLinesMode ? "mt-3" : "")">
    @if (!price.DisableBuyButton && list.BuyEnabled)
    {
        <div class="d-flex gap-2 w-100">
            @{ RenderBuyButton(false); }
            @{ RenderBuyNowButton(false); }
        </div>
    }

    @if (!price.DisableWishlistButton && list.WishlistEnabled)
    {
        <a data-href="@Url.Action("AddProductSimple", "ShoppingCart", new { productId = Model.Id, shoppingCartTypeId = (int)ShoppingCartType.Wishlist, area = "" })"
           href="#"
           class="btn btn-secondary btn-lg art-btn col ajax-cart-link add-to-wishlist-button"
           title="@T("Categories.Wishlist")"
           data-toggle="tooltip" data-placement="bottom"
           rel="nofollow"
           data-type="wishlist"
           data-action="add">
            <i class="fal fa-heart"></i>
        </a>
    }
    else if (isLinesMode)
    {
        <span class="art-btn-spacer col"></span>
    }

    @if (list.CompareEnabled)
    {
        <a data-href="@Url.Action("AddProductToCompare", "Catalog", new { id = Model.Id, area = "" })"
           href="#"
           class="btn btn-secondary btn-lg art-btn col ajax-cart-link add-to-compare-list-button"
           title="@T("Categories.Compare")"
           data-toggle="tooltip"
           data-placement="bottom"
           rel="nofollow"
           data-type="compare"
           data-action="add">
            <i class="fa fa-retweet"></i>
        </a>
    }
    else if (isLinesMode)
    {
        <span class="art-btn-spacer col"></span>
    }

    <a href="@Model.DetailUrl"
       class="btn btn-secondary btn-lg art-btn col product-details-button"
       title="@T("Products.Details")"
       data-toggle="tooltip"
       data-placement="bottom">
        <i class="fa fa-info"></i>
    </a>
</div>
