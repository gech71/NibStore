@using Smartstore.Admin.Models.Catalog
@model ProductListModel

@{
    ViewBag.Title = "Apply Discount to Products";
}

<div class="section-header">
    <div class="title">
        <i class="fa fa-tag"></i>
        Apply Discount to Products
    </div>
</div>

@{
    var gridViewData = new ViewDataDictionary(this.ViewData);
    gridViewData["Parent"] = Model;
}

<partial name="~/Areas/Admin/Views/Product/Grids/_Grid.Products.cshtml" model="null" view-data="gridViewData" /><div id="apply-discount-window" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1060; background: white; padding: 20px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); width: 500px; max-width: 90%;">
    <div style="position: relative;">
        <button type="button" class="close" style="position: absolute; right: 10px; top: 5px;" onclick="$('#apply-discount-window').hide();">&times;</button>
        <h4 style="margin-top: 0; padding-right: 20px;">@T("Admin.Catalog.Products.ApplyDiscount")</h4>
        <div class="form-group" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px;">@T("Admin.Promotions.Discounts")</label>
            <select id="discount-id" name="discountId" class="form-control" style="width: 100%;">
                <option value="0">@T("Admin.Common.PleaseSelect")</option>
            </select>
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button type="button" class="btn btn-secondary" onclick="$('#apply-discount-window').hide();">@T("Common.Cancel")</button>
            <button type="button" id="apply-discount" class="btn btn-primary">@T("Common.Apply")</button>
        </div>
    </div>
</div>
<div id="modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050;"></div>

<script sm-target-zone="scripts" data-origin="products-grid">
    $(function () {
        // Localization strings
        var resources = {
            'Admin.Common.NoItemsSelected': '@T("Admin.Common.NoItemsSelected")',
            'Admin.Common.PleaseSelectDiscount': '@T("Admin.Common.PleaseSelect")',
            'Admin.Common.Error': '@T("Admin.Common.Error")',
            'Common.Processing': '@T("Common.Processing")',
            'Admin.Catalog.Products.ApplyDiscount': '@T("Admin.Catalog.Products.ApplyDiscount")',
            'Admin.Promotions.Discounts': '@T("Admin.Promotions.Discounts")',
            'Common.Cancel': '@T("Common.Cancel")',
            'Common.Apply': '@T("Common.Apply")'
        };

        window.Res.DataGrid.confirmDelete = @T("Admin.DataGrid.ConfirmSoftDelete").JsValue;
        window.Res.DataGrid.confirmDeleteMany = @T("Admin.DataGrid.ConfirmSoftDeleteMany").JsValue;

        var $modal = $('#apply-discount-window');
        
        // Load discounts for dropdown
        function loadDiscounts() {
            return $.ajax({
                url: '@Url.Action("AllDiscounts", "Discount")',
                data: { type: 2 }, // 2 = DiscountType.AssignedToSkus for product-specific discounts
                type: 'GET'
            });
        }
        
        // Function to show the modal
        function showDiscountModal() {
            var grid = $('#products-grid').parent().data('datagrid');
            var selectedIds = grid.selectedRowKeys;
            
            if (!selectedIds || selectedIds.length === 0) {
                alert(resources['Admin.Common.NoItemsSelected']);
                return false;
            }
            
            var $dropdown = $('#discount-id');
            $dropdown.empty().append($('<option/>').val('0').text(resources['Admin.Common.PleaseSelectDiscount']));
            
            // Show modal and backdrop
            $('#apply-discount-window, #modal-backdrop').show();
            
            // Load discounts
            loadDiscounts()
                .done(function(data) {
                    // Populate dropdown
                    data.forEach(function(item) {
                        $dropdown.append($('<option/>').val(item.id).text(item.text));
                    });
                })
                .fail(function() {
                    alert(resources['Admin.Common.Error']);
                    $('#apply-discount-window, #modal-backdrop').hide();
                });
            
            return false;
        }
        
        // Handle apply discount button click
        $(document).on('click', '#apply-discount-selected', function (e) {
            e.preventDefault();
            e.stopPropagation();
            showDiscountModal();
        });
        
        // Close modal when clicking on backdrop
        $('#modal-backdrop').on('click', function() {
            $('#apply-discount-window, #modal-backdrop').hide();
        });

        // Handle apply discount confirmation
        $(document).on('click', '#apply-discount', function () {
            var discountId = $('#discount-id').val();
            if (!discountId || discountId === '0') {
                alert(resources['Admin.Common.PleaseSelectDiscount']);
                return;
            }
            
            var grid = $('#products-grid').parent().data('datagrid');
            var selectedIds = grid.selectedRowKeys;
            
            if (!selectedIds || selectedIds.length === 0) {
                return;
            }
            
            var $btn = $(this);
            $btn.prop('disabled', true).addClass('disabled');
            
            // Show loading state
            var originalText = $btn.text();
            $btn.html('<i class="fa fa-spinner fa-spin"></i> ' + resources['Common.Processing']);
            
            // Get the URL from the button's data attribute
            var url = $('#apply-discount-selected').data('url');
            
            // Log the data being sent for debugging
            console.log('Sending request to:', url);
            console.log('Selected IDs:', selectedIds);
            console.log('Discount ID:', discountId);
            
            $.ajax({
                url: url,
                type: 'POST',
                data: JSON.stringify({
                    selectedIds: selectedIds,
                    discountId: discountId
                }),
                contentType: 'application/json',
                dataType: 'json',
                success: function (response) {
                    console.log('Response received:', response);
                    if (response && response.success) {
                        displayNotification(response.message || 'Discount applied successfully', 'success');
                        // Refresh the grid by triggering the Smartstore grid's refresh
                        var $grid = $('#products-grid');
                        var dataGrid = $grid.data('datagrid');
                        if (dataGrid && typeof dataGrid.ajaxRequest === 'function') {
                            dataGrid.ajaxRequest();
                        } else {
                            // Fallback to page reload if we can't refresh the grid
                            window.location.reload();
                        }
                    } else {
                        var errorMsg = response && response.message ? response.message : 'An unknown error occurred';
                        displayNotification(errorMsg, 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('AJAX Error:', status, error);
                    displayNotification(resources['Admin.Common.Error'] + ': ' + (xhr.responseJSON?.message || error), 'error');
                },
                complete: function () {
                    // Hide the modal and reset button state
                    $('#apply-discount-window, #modal-backdrop').hide();
                    $btn.prop('disabled', false).removeClass('disabled').text(originalText);
                }
            });
        });
        
        // Reset form when modal is closed
        $modal.on('hidden.bs.modal', function () {
            $(this).find('form')[0]?.reset();
            $('#discount-id').empty().append($('<option/>').val('0').text(resources['Admin.Common.PleaseSelectDiscount']));
        });
    });
</script>