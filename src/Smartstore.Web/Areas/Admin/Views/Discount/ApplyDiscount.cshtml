@using Smartstore.Admin.Models.Catalog
@model ProductListModel

@{
    ViewBag.Title = "Apply Discount to Products";
}

<div class="section-header">
    <div class="title">
        <i class="fa fa-tag"></i>
        Apply Discount to Products
    </div>
</div>

@{
    var gridViewData = new ViewDataDictionary(ViewData);
    gridViewData["Parent"] = Model;
}

<!-- Render the standard product grid, modified for discount context -->
<partial name="~/Areas/Admin/Views/Product/Grids/_Grid.Products.cshtml" model="Model" view-data="gridViewData" />

<!-- Include the discount modal partial -->
<partial name="~/Areas/Admin/Views/Discount/_ApplyDiscountModal.cshtml" />

<!-- Scripts specific to Apply Discount -->
<script sm-target-zone="scripts" data-origin="products-grid">
    $(function () {
        window.Res.DataGrid.confirmDelete = @T("Admin.DataGrid.ConfirmSoftDelete").JsValue;
        window.Res.DataGrid.confirmDeleteMany = @T("Admin.DataGrid.ConfirmSoftDeleteMany").JsValue;

        Smartstore.DataGrid.get("products-grid").onSelectionChanged(function (e) {
            const selected = e.sender.getSelectedRowIds();
            $('#btn-apply-discount').prop('disabled', selected.length === 0);
        });
    });

    function openDiscountModal() {
        $('#apply-discount-modal').modal('show');
    }

    function submitDiscount() {
        const selectedDiscountId = $('#discountId').val();
        const note = $('#note').val();

        if (!selectedDiscountId) {
            alert('@T("Admin.Promotions.SelectDiscountAlert")');
            return;
        }

        const selectedProductIds = Smartstore.DataGrid.get("products-grid").getSelectedRowIds();

        $.ajax({
            url: '@Url.Action("ApplyDiscount", "Discount")',
            type: 'POST',
            data: {
                productIds: selectedProductIds,
                discountId: selectedDiscountId,
                note: note
            },
            success: function () {
                $('#apply-discount-modal').modal('hide');
                Smartstore.alert.success('@T("Admin.Promotions.DiscountAppliedSuccessfully")');
                Smartstore.DataGrid.get("products-grid").reload();
            },
            error: function () {
                Smartstore.alert.error('@T("Admin.Promotions.DiscountApplyFailed")');
            }
        });
    }
</script>
