@model ProductDiscountViewModel

<datagrid id="product-discounts-grid"
          key-member="ProductId"
          allow-resize="true"
          allow-row-selection="true"
          preserve-grid-state="true" 
          preserve-command-state="true"
          allow-column-reordering="true">
    <datasource read="@Url.Action("ProductDiscountList", "Discount")" />
    
    <sorting allow-unsort="true" allow-multisort="false">
        <sort by="ProductName" />
    </sorting>
    
    <toolbar>
        <toolbar-group>
            <button datagrid-action="DataGridToolAction.ToggleSearchPanel" type="button" class="btn btn-light btn-icon">
                <i class="fa fa-fw fa-filter"></i>
            </button>
        </toolbar-group>
        <toolbar-group class="omega"></toolbar-group>
        <toolbar-group>
            <button id="remove-discount-btn" type="button" class="btn btn-danger no-anims btn-flat">
                <i class="fa fa-minus"></i>
                <span>@T("Admin.Promotions.Discounts.RemoveDiscount")</span>
            </button>
        </toolbar-group>
    </toolbar>
    
    <columns>
        <column for="ProductName" />
        <column for="DiscountName" />
        <column for="Price" />
        <column for="DiscountPercentage" />
        <column for="DiscountAmount" />
        <column for="StartDateUtc" />
        <column for="EndDateUtc" />
    </columns>
</datagrid>
<div id="remove-discount-modal" class="modal" style="display:none;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@T("Admin.Promotions.Discounts.RemoveDiscount")</h5>
                <button type="button" class="btn-close" onclick="$('#remove-discount-modal').hide();"></button>
            </div>
            <div class="modal-body">
                <select id="discount-select" class="form-control">
                    <option value="">@T("Admin.Common.PleaseSelect")</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="$('#remove-discount-modal').hide();">@T("Common.Cancel")</button>
                <button class="btn btn-danger" id="confirm-remove">@T("Admin.Common.Delete")</button>
            </div>
        </div>
    </div>
</div>
<script>
$(function() {
    var resources = {
        NoItemsSelected: '@T("Admin.Common.NoItemsSelected")',
        PleaseSelect: '@T("Admin.Common.PleaseSelect")',
        Error: '@T("Admin.Common.Error")',
        ChangesSaved: '@T("Admin.Common.ChangesSaved")',
        NoDiscounts: '@T("Admin.Catalog.Products.NoDiscounts")'
    };

    var $grid = $('#product-discounts-grid').parent().data('datagrid');
    var $modal = $('#remove-discount-modal');

    $('#remove-discount-btn').on('click', function() {
        var selectedIds = $grid.selectedRowKeys;
        
        if (!selectedIds || selectedIds.length === 0) {
            displayNotification(resources.NoItemsSelected, 'warning');
            return;
        }

        // Convert IDs to numbers if needed
        selectedIds = selectedIds.map(id => parseInt(id));

        var discountPromises = selectedIds.map(function(productId) {
            return $.get('@Url.Action("GetDiscountsForProduct", "Discount")', { productId: productId });
        });

        Promise.all(discountPromises)
            .then(function(allDiscounts) {
                var combinedDiscounts = [];
                var discountIds = new Set();
                
                allDiscounts.forEach(function(productDiscounts) {
                    if (productDiscounts && productDiscounts.length) {
                        productDiscounts.forEach(function(discount) {
                            if (!discountIds.has(discount.discountId)) {
                                discountIds.add(discount.discountId);
                                combinedDiscounts.push(discount);
                            }
                        });
                    }
                });

                populateDiscountSelect(combinedDiscounts);
                $modal.show();
            })
            .catch(function(error) {
                console.error("Error fetching discounts:", error);
                displayNotification(resources.Error, 'error');
            });
    });

    // ... rest of your existing functions ...

    $('#confirm-remove').on('click', function() {
        var discountId = parseInt($('#discount-select').val());
        var selectedIds = $grid.selectedRowKeys.map(id => parseInt(id));
        
        if (!discountId) {
            displayNotification(resources.PleaseSelect, 'warning');
            return;
        }

        if (!selectedIds || selectedIds.length === 0) {
            displayNotification(resources.NoItemsSelected, 'warning');
            return;
        }

        var $btn = $(this);
        $btn.prop('disabled', true);
        
        $.ajax({
            url: '@Url.Action("RemoveDiscountFromSelectedProducts", "Discount")',
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            data: JSON.stringify({
                selectedIds: selectedIds,
                discountId: discountId
            }),
            success: function(response) {
                if (response.success) {
                    displayNotification(response.message || resources.ChangesSaved);
                    $grid.ajaxRequest();
                    $modal.hide();
                } else {
                    displayNotification(response.message || resources.Error, 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error("Remove error:", status, error, xhr.responseText);
                displayNotification(resources.Error + ": " + (xhr.responseJSON?.message || error), 'error');
            },
            complete: function() {
                $btn.prop('disabled', false);
            }
        });
    });
});
</script>